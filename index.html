<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulo Richiesta Fattura - Lock & Fly</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 12mm;
            box-sizing: border-box;
            page-break-after: always;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 3px solid #1e3a8a;
            padding-bottom: 10px;
        }

        .logo-container {
            margin-bottom: 8px;
        }

        .logo {
            max-width: 150px;
            max-height: 100px;
            display: block;
            margin: 0 auto;
            object-fit: contain;
        }

        .header h1 {
            color: #1e3a8a;
            font-size: 22px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 12px;
            font-style: italic;
            margin: 0;
        }

        /* SEZIONI */
        .section {
            margin: 3px 0;
        }

        .section-title {
            background: #1e3a8a;
            color: white;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
            border-radius: 4px;
        }

        /* FORM GROUP */
        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-group.full {
            grid-template-columns: 1fr;
        }

        .form-group.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field label {
            font-weight: 600;
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
        }

        .field input[type="text"],
        .field input[type="email"],
        .field input[type="tel"],
        .field input[type="date"],
        .field textarea {
            padding: 6px;
            border: none;
            border-bottom: 2px solid #ddd;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .field input[type="text"]:focus,
        .field input[type="email"]:focus,
        .field input[type="tel"]:focus,
        .field input[type="date"]:focus,
        .field textarea:focus {
            outline: none;
            border-bottom: 2px solid #1e3a8a;
            background: #f0f4ff;
        }

        .field textarea {
            resize: vertical;
            min-height: 35px;
            border: 1px solid #ddd;
            padding: 4px;
            border-radius: 4px;
        }

        /* CHECKBOX E RADIO */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #1e3a8a;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            font-size: 12px;
            cursor: pointer;
        }

        /* DATA E IMPORTO INLINE */
        .date-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* FIRMA CON CANVAS */
        .signature-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 30px;
            border-top: 2px solid #f0f0f0;
            padding-top: 20px;
        }

        .signature-box {
            border: 2px solid #1e3a8a;
            border-radius: 4px;
            padding: 0;
            background: white;
            cursor: crosshair;
            overflow: hidden;
            position: relative;
        }

        #signatureCanvas {
            display: block;
            width: 100%;
            height: 120px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-buttons {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-small-clear {
            background: #ef4444;
            color: white;
        }

        .btn-small-clear:hover {
            background: #dc2626;
        }

        .signature-hint {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            font-style: italic;
        }

        /* OPZIONI FIRMA */
        .signature-options {
            background: #f0f4ff;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #1e3a8a;
        }

        .signature-options p {
            font-size: 11px;
            color: #333;
            margin: 0 0 4px 0;
            font-weight: 500;
        }

        /* PULSANTI */
        .button-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1e3a8a;
            color: white;
        }

        .btn-primary:hover {
            background: #1e2d5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #0891b2;
            color: white;
        }

        .btn-info:hover {
            background: #0e7490;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* FOOTER */
        .footer {
            text-align: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #ddd;
            font-size: 10px;
            color: #999;
        }

        /* ISTRUZIONI FINALI - CORRETTO */
        #istruzioniFinali {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 2px solid #28a745;
            display: none; /* Nascosto inizialmente */
            width: 100%;
        }

        #istruzioniFinali h2 {
            color: #155724;
            margin: 0 0 10px 0;
            font-size: 18px;
            border-bottom: 1px solid #c3e6cb;
            padding-bottom: 5px;
        }

        .istruzioni-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: left;
        }

        .istruzioni-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }

        .istruzioni-box p {
            margin: 5px 0;
            font-size: 12px;
            color: #333;
        }

        .istruzioni-box strong {
            color: #155724;
        }

        .istruzioni-box ul {
            padding-left: 20px;
            margin: 5px 0;
            font-size: 12px;
        }

        .istruzioni-box li {
            margin-bottom: 4px;
        }

        .highlight-contact {
            color: #0891b2;
            font-weight: bold;
            font-size: 13px;
        }

        /* PRINT STYLE */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 20mm;
                page-break-after: always;
                height: auto;
            }
            .button-group, 
            .signature-buttons,
            .signature-hint,
            .signature-options,
            #istruzioniFinali {
                display: none !important;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .form-group,
            .form-group.triple,
            .date-row,
            .signature-section {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 18px;
            }
            .istruzioni-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="moduloContainer">
        <!-- HEADER -->
        <div class="header">
            <div class="logo-container">
                <!-- IMPORTANTE: Assicurati che il file logo sia presente -->
                <img src="logo lock and fly malpensa.jpg" alt="Lock & Fly Logo" class="logo" crossOrigin="anonymous" onerror="this.style.display='none'">
            </div>
            <h1>MODULO RICHIESTA FATTURA</h1>
            <p>Lock & Fly - Parcheggi Malpensa</p>
        </div>

        <form id="moduloFattura">
            <!-- SEZIONE 1: DATI CLIENTE -->
            <div class="section">
                <div class="section-title">DATI DEL CLIENTE</div>
                
                <div class="form-group">
                    <div class="field">
                        <label for="nome">Nome e Cognome *</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>
                    <div class="field">
                        <label for="ragioneSociale">Ragione Sociale (se azienda)</label>
                        <input type="text" id="ragioneSociale" name="ragioneSociale">
                    </div>
                </div>

                <div class="form-group">
                    <div class="field">
                        <label for="codiceFiscale">Codice Fiscale / Partita IVA *</label>
                        <input type="text" id="codiceFiscale" name="codiceFiscale" required>
                    </div>
                    <div class="field">
                        <label for="indirizzo">Indirizzo completo *</label>
                        <input type="text" id="indirizzo" name="indirizzo" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="field">
                        <label for="cap">CAP / Citt√† / Provincia *</label>
                        <input type="text" id="cap" name="cap" required>
                    </div>
                    <div class="field">
                        <label for="email">E-mail *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="field">
                        <label for="telefono">Telefono *</label>
                        <input type="tel" id="telefono" name="telefono" required>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 2: DETTAGLI SERVIZIO -->
            <div class="section">
                <div class="section-title">DETTAGLI DEL SERVIZIO / PARCHEGGIO</div>
                
                <div class="date-row">
                    <div class="field">
                        <label for="dataIngresso">Data di ingresso *</label>
                        <input type="date" id="dataIngresso" name="dataIngresso" required>
                    </div>
                    <div class="field">
                        <label for="dataUscita">Data di uscita *</label>
                        <input type="date" id="dataUscita" name="dataUscita" required>
                    </div>
                </div>

                <div class="form-group full">
                    <div class="field">
                        <label for="targa">Targa veicolo *</label>
                        <input type="text" id="targa" name="targa" placeholder="es. MI 123AB" required>
                    </div>
                </div>

                <div class="form-group full">
                    <div class="field">
                        <label>Tipologia servizio *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="std" name="servizio" value="Parcheggio Standard">
                                <label for="std">Parcheggio Standard</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="vip" name="servizio" value="VIP Parking">
                                <label for="vip">VIP Parking</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="navetta" name="servizio" value="Navetta Aeroportuale">
                                <label for="navetta">Navetta Aeroportuale</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="carwash" name="servizio" value="Car Wash">
                                <label for="carwash">Car Wash</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="coperto" name="servizio" value="Parcheggio Coperto">
                                <label for="coperto">Parcheggio Coperto</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="scoperto" name="servizio" value="Parcheggio Scoperto">
                                <label for="scoperto">Parcheggio Scoperto</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="tieni" name="servizio" value="Tieni le Chiavi">
                                <label for="tieni">Tieni le Chiavi</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="lascia" name="servizio" value="Lascia le Chiavi">
                                <label for="lascia">Lascia le Chiavi</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="altro" name="servizio" value="Altro">
                                <label for="altro">Altro</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="field">
                        <label for="importo">Importo pagato *</label>
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 16px; margin-right: 8px;">‚Ç¨</span>
                            <input type="text" id="importo" name="importo" placeholder="0,00" required style="flex: 1;">
                        </div>
                    </div>
                    <div class="field">
                        <label>Metodo di pagamento *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" id="contanti" name="pagamento" value="Contanti" required>
                                <label for="contanti">Contanti</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="carta" name="pagamento" value="Carta">
                                <label for="carta">Carta</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="online" name="pagamento" value="Online">
                                <label for="online">Online</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 3: NOTE -->
            <div class="section">
                <div class="section-title">NOTE DEL CLIENTE</div>
                <div class="form-group full">
                    <div class="field">
                        <label for="note">Note aggiuntive</label>
                        <textarea id="note" name="note" placeholder="Inserisci qui qualsiasi nota o informazione aggiuntiva..."></textarea>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 3.5: RECENSIONE -->
            <div class="section" data-html2canvas-ignore="true">
                <div class="section-title">‚≠ê CI PIACEREBBE CONOSCERE TUA OPINIONE</div>
                <div style="background: linear-gradient(135deg, #c2e59c 0%, #64b5f6 100%); padding: 12px; border-radius: 8px; text-align: center;">
                    <p style="color: #1e3a8a; font-size: 12px; font-weight: 500; margin-bottom: 8px;">
                        Siamo felici di averti servito! Se sei soddisfatto, lascia una <strong>recensione</strong>. 
                    </p>
                    <p style="color: #1e3a8a; font-size: 11px; margin-bottom: 10px;">
                        Le tue opinioni ci aiutano a migliorare.
                    </p>
                    <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                        <a href="https://maps.google.com/?q=Lock+Fly+Malpensa+T1+T2" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; background: white; color: #1e3a8a; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 11px; transition: all 0.3s;">
                            üîç Google
                        </a>
                        <a href="https://www.trustpilot.com/" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; background: #ccc; color: #999; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 11px; transition: all 0.3s; cursor: not-allowed; opacity: 0.6;" onclick="return false;">
                            ‚≠ê Trustpilot
                        </a>
                        <a href="mailto:direzione@lockandfly.com?subject=Feedback%20Lock%20%26%20Fly" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; background: white; color: #1e3a8a; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 11px; transition: all 0.3s;">
                            üìß Contatti
                        </a>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 4: DICHIARAZIONE E FIRMA -->
            <div class="section">
                <div class="section-title">DICHIARAZIONE E FIRMA</div>
                <p style="margin-bottom: 8px; font-size: 12px; color: #333;">
                    <strong>Dichiaro</strong> che i dati forniti sono corretti e autorizzo l'emissione della fattura elettronica.
                </p>
                
                <!-- Opzioni firma: Ignora in screenshot -->
                <div class="signature-options" data-html2canvas-ignore="true">
                    <p>üìù Scegli come firmare:</p>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="firmaDig" name="tipoFirma" value="digitale" checked>
                            <label for="firmaDig"><strong>Firma grafica</strong> (disegna con il dito)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="firmaMan" name="tipoFirma" value="manuale">
                            <label for="firmaMan"><strong>Firma manuale</strong> (scarica e firma a mano)</label>
                        </div>
                    </div>
                </div>

                <div class="signature-section" id="firmaDigitalSection">
                    <div class="field">
                        <label>Firma (dito o mouse) *</label>
                        <div class="signature-box">
                            <canvas id="signatureCanvas"></canvas>
                        </div>
                        <div class="signature-buttons" data-html2canvas-ignore="true">
                            <button type="button" class="btn-small btn-small-clear" onclick="clearSignature()">
                                üóëÔ∏è Cancella
                            </button>
                        </div>
                        <div class="signature-hint" data-html2canvas-ignore="true">
                            üí° Firma con dito o mouse
                        </div>
                    </div>
                    <div class="field">
                        <label for="dataFirma">Data *</label>
                        <input type="date" id="dataFirma" name="dataFirma" required>
                    </div>
                </div>

                <div class="signature-section" id="firmaManualSection" style="display: none;">
                    <div class="field">
                        <label>Firma del cliente</label>
                        <div style="min-height: 60px; border: none; border-bottom: 2px dashed #999; padding: 10px 0; text-align: center; color: #999; display: flex; align-items: center; justify-content: center; font-size: 12px; font-style: italic;">
                            _____________________________
                        </div>
                    </div>
                    <div class="field">
                        <label for="dataFirmaMan">Data *</label>
                        <input type="date" id="dataFirmaMan" name="dataFirmaMan" required>
                    </div>
                </div>
            </div>

            <!-- PULSANTI (Ignorati nello screenshot) -->
            <div class="button-group" data-html2canvas-ignore="true">
                <!-- Bottone Firma Digitale -->
                <button type="button" class="btn-success" id="btnInviaPDF" onclick="inviaConFirmaDigitale(event); return false;">
                    üìß SALVA E MOSTRA ISTRUZIONI
                </button>
                
                <!-- Bottone Firma Manuale (Nascosto se √® attiva la firma digitale, ma manteniamo la logica vecchia per compatibilit√†) -->
                <button type="button" class="btn-primary" id="btnScaricaPDF" onclick="scaricaPDFManuale()" style="display: none;">
                    üì• SCARICA PDF PER FIRMARE
                </button>
                
                <!-- NUOVO BOTTONE RICHIESTO: SOSTITUISCE "ESPORTA EMAIL" -->
                <button type="button" class="btn-info" onclick="scaricaPerFirmaManuale()">
                    üìù SCARICA E FIRMA IL MODULO E SEGUI ISTRUZIONI
                </button>
                
                <button type="reset" class="btn-secondary" onclick="clearSignature()">
                    üóëÔ∏è PULISCI
                </button>
            </div>

            <!-- Istruzioni finali -->
            <div id="istruzioniFinali" data-html2canvas-ignore="true">
                <h2>‚úÖ MODULO COMPILATO</h2>
                <div style="margin-bottom: 10px; font-weight: 500; font-size: 14px;">Ecco come inviare il modulo:</div>
                
                <div class="istruzioni-container">
                    <div class="istruzioni-box">
                        <p><strong>üìß Invia il modulo a:</strong></p>
                        <p class="highlight-contact">direzione@lockandfly.com</p>
                        <p style="margin-top: 8px;">oppure contatta il parcheggio</p>
                        <p class="highlight-contact">+39 340 1743507</p>
                    </div>
                    
                    <div class="istruzioni-box">
                        <p><strong>üìã Procedura:</strong></p>
                        <ul>
                            <li>Apri la tua app email</li>
                            <li>Nuovo messaggio a: <span style="color: #0891b2;">direzione@lockandfly.com</span></li>
                            <li>Allega questo modulo (immagine appena scaricata)</li>
                            <li>Invia il messaggio</li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>            

        <!-- FOOTER -->
        <div class="footer">
            <p><strong>Lock & Fly</strong> | Parcheggi Malpensa | lockandfly.it</p>
            <p style="margin-top: 4px; font-size: 10px;">üìß direzione@lockandfly.com | üìû +39 340 1743507</p>
            <p style="margin-top: 2px; font-size: 9px;">Compilato il: <span id="dataCompilazione"></span></p>
        </div>
    </div>

    <script>
        // ===== GESTIONE FIRMA CON CANVAS =====
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Imposta le dimensioni reali del canvas (Fix alta risoluzione/retina display)
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            // Aumenta risoluzione interna per schermi HDPI
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            
            canvas.width = rect.width * ratio;
            canvas.height = rect.height * ratio;
            
            // Scala il contesto
            ctx.scale(ratio, ratio);
            
            // Stile CSS rimane lo stesso
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 2; // Spessore linea
            ctx.strokeStyle = '#1e3a8a';
        }

        // Ritarda il resize per assicurarsi che il layout sia stabile
        setTimeout(resizeCanvas, 100);
        window.addEventListener('resize', resizeCanvas);

        // Funzioni helper coordinate
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        // Event Listeners unificati
        ['mousedown', 'touchstart'].forEach(evt => 
            canvas.addEventListener(evt, startDrawing, {passive: false})
        );
        ['mousemove', 'touchmove'].forEach(evt => 
            canvas.addEventListener(evt, draw, {passive: false})
        );
        ['mouseup', 'mouseout', 'touchend'].forEach(evt => 
            canvas.addEventListener(evt, stopDrawing)
        );

        function startDrawing(e) {
            if (e.type === 'touchstart') e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            if (e.type === 'touchmove') e.preventDefault();
            
            const pos = getPos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Data compilazione
        document.getElementById('dataCompilazione').textContent = new Date().toLocaleDateString('it-IT');

        // SELEZIONE TIPO FIRMA
        document.querySelectorAll('input[name="tipoFirma"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const firmaDigitalSection = document.getElementById('firmaDigitalSection');
                const firmaManualSection = document.getElementById('firmaManualSection');
                const btnInviaPDF = document.getElementById('btnInviaPDF');
                const btnScaricaPDF = document.getElementById('btnScaricaPDF');

                if (this.value === 'digitale') {
                    firmaDigitalSection.style.display = 'grid';
                    firmaManualSection.style.display = 'none';
                    btnInviaPDF.style.display = 'block';
                    btnScaricaPDF.style.display = 'none';
                } else {
                    firmaDigitalSection.style.display = 'none';
                    firmaManualSection.style.display = 'grid';
                    btnInviaPDF.style.display = 'none';
                    btnScaricaPDF.style.display = 'block';
                }
            });
        });

        // ===== SCARICA PNG CON FIRMA GRAFICA (Bottone Verde) =====
        function inviaConFirmaDigitale(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            if (!validaFormDigitale()) return;

            const nome = document.getElementById('nome').value || 'Cliente';
            const elemento = document.getElementById('moduloContainer');

            // Feedback visivo immediato
            const originalBtnText = document.getElementById('btnInviaPDF').innerHTML;
            document.getElementById('btnInviaPDF').innerHTML = '‚è≥ Generazione in corso...';

            html2canvas(elemento, {
                scale: 2, // Migliore qualit√†
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Modulo_Fattura_Lock_Fly_${nome.replace(/\s+/g, '_')}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    mostraIstruzioniFinali();
                    document.getElementById('btnInviaPDF').innerHTML = originalBtnText;

                }, 'image/jpeg', 0.85);
            }).catch(err => {
                console.error('Errore nella generazione dell\'immagine:', err);
                alert('‚ùå Errore nel download.');
                document.getElementById('btnInviaPDF').innerHTML = originalBtnText;
            });
        }

        // ===== NUOVA FUNZIONE PER SCARICARE MODULO DA FIRMARE A MANO (Bottone Azzurro) =====
        function scaricaPerFirmaManuale() {
            // 1. Validazione base (solo dati anagrafici, NO firma canvas)
            if (!validaSoloDati()) return;

            const nome = document.getElementById('nome').value || 'Cliente';
            const elemento = document.getElementById('moduloContainer');
            
            // 2. Automazione UI: Assicura che la vista sia impostata su "Firma Manuale" 
            // per far apparire la riga tratteggiata invece del canvas vuoto.
            const radioManuale = document.getElementById('firmaMan');
            const radioDigitale = document.getElementById('firmaDig');
            const eraDigitale = radioDigitale.checked;

            // Forza il passaggio alla vista manuale
            if (eraDigitale) {
                radioManuale.click(); 
            }

            // Feedback visivo
            const btn = document.querySelector('.btn-info');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generazione PDF/JPG...';

            // Timeout breve per assicurare che il browser abbia renderizzato il cambio di vista
            setTimeout(() => {
                html2canvas(elemento, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `Modulo_Da_Firmare_${nome.replace(/\s+/g, '_')}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        // Ripristina testo pulsante
                        btn.innerHTML = originalText;

                        // 3. Mostra le istruzioni finali
                        mostraIstruzioniFinali();
                        
                        // Opzionale: Se vuoi che torni alla vista digitale dopo il download, decommenta la riga sotto.
                        // Altrimenti lo lasciamo cos√¨ perch√© l'utente ha appena scelto di firmare manualmente.
                        // if (eraDigitale) radioDigitale.click();

                        alert('‚úÖ Modulo scaricato!\nOra stampalo, firmalo a mano e invialo via email come indicato.');

                    }, 'image/jpeg', 0.85);
                }).catch(err => {
                    console.error(err);
                    alert('Errore generazione immagine');
                    btn.innerHTML = originalText;
                });
            }, 100);
        }

        // Funzione per mostrare le istruzioni
        function mostraIstruzioniFinali() {
            const istruzioni = document.getElementById('istruzioniFinali');
            istruzioni.style.display = 'block';
            setTimeout(() => {
                 istruzioni.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // ===== SCARICA PNG PER FIRMA MANUALE (Bottone Blu Scuro legacy) =====
        function scaricaPDFManuale() {
            // Questa funzione rimane per il bottone che appare solo se si seleziona "Firma Manuale" esplicitamente
            // Ma ora la logica √® replicata nel bottone Azzurro.
            if (!validaSoloDati()) return;
            const nome = document.getElementById('nome').value || 'Cliente';
            const elemento = document.getElementById('moduloContainer');

            html2canvas(elemento, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Modulo_Da_Firmare_${nome.replace(/\s+/g, '_')}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    mostraIstruzioniFinali();
                }, 'image/jpeg', 0.85);
            });
        }

        // VALIDAZIONE COMPLETA (include Canvas)
        function validaFormDigitale() {
            if (!validaSoloDati()) return false;

            const pixelBuffer = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const hasDrawing = pixelBuffer.some(channel => channel !== 0);
            
            if (!hasDrawing) {
                alert('‚ö†Ô∏è Apponi la tua Firma nel riquadro apposito');
                return false;
            }
            return true;
        }

        // VALIDAZIONE SOLO DATI (Esclude Canvas)
        function validaSoloDati() {
            const requiredIds = ['nome', 'codiceFiscale', 'indirizzo', 'email', 'telefono', 'dataIngresso', 'dataUscita', 'targa', 'importo'];
            
            for (let id of requiredIds) {
                if (!document.getElementById(id).value) {
                    alert(`‚ö†Ô∏è Campo obbligatorio mancante: ${id.replace(/([A-Z])/g, ' $1').toUpperCase()}`);
                    document.getElementById(id).focus();
                    return false;
                }
            }
            
            if (document.querySelectorAll('input[name="servizio"]:checked').length === 0) {
                alert('‚ö†Ô∏è Seleziona almeno una Tipologia di Servizio');
                return false;
            }
            if (!document.querySelector('input[name="pagamento"]:checked')) {
                alert('‚ö†Ô∏è Seleziona un Metodo di Pagamento');
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
